<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>js-bits tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="data:," />
    <style>
      .results {
        font-family: monospace;
      }
      .passed {
        color: green;
      }
      .failed {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Test Results</h1>

    <h2>crypto.mjs</h2>
    <div class="results" id="cryptoTestResults"></div>

    <h2>db.mjs</h2>
    <div class="results" id="dbTestResults"></div>

    <h2>fluid.mjs</h2>
    <div class="results" id="fluidTestResults"></div>

    <h2>prelude.mjs</h2>
    <div class="results" id="preludeTestResults"></div>

    <script type="module">
      let testMod;
      let cryptoTestMod;
      let dbTestMod;
      let fluidTestMod;
      let preludeTestMod;

      const clearResults = () => {
        const cryptoResultsDiv = document.getElementById('cryptoTestResults');
        cryptoResultsDiv.innerHTML = '';
        const dbResultsDiv = document.getElementById('dbTestResults');
        dbResultsDiv.innerHTML = '';
        const fluidResultsDiv = document.getElementById('fluidTestResults');
        fluidResultsDiv.innerHTML = '';
        const preludeResultsDiv = document.getElementById('preludeTestResults');
        preludeResultsDiv.innerHTML = '';
      };

      const loadModules = async (stamp = true) => {
        const timestamp = new Date().getTime();
        const testModulePath = stamp
          ? `./test.mjs?v=${timestamp}`
          : './test.mjs';
        const cryptoTestModulePath = stamp
          ? `./crypto.test.mjs?v=${timestamp}`
          : './crypto.test.mjs';
        const dbTestModulePath = stamp
          ? `./db.test.mjs?v=${timestamp}`
          : './db.test.mjs';
        const fluidTestModulePath = stamp
          ? `./fluid.test.mjs?v=${timestamp}`
          : './fluid.test.mjs';
        const preludeTestModulePath = stamp
          ? `./prelude.test.mjs?v=${timestamp}`
          : './prelude.test.mjs';
        testMod = await import(testModulePath);
        cryptoTestMod = await import(cryptoTestModulePath);
        dbTestMod = await import(dbTestModulePath);
        fluidTestMod = await import(fluidTestModulePath);
        preludeTestMod = await import(preludeTestModulePath);
      };

      const runTests = async () => {
        await Promise.all([
          testMod.runner(
            cryptoTestMod.tests,
            document.getElementById('cryptoTestResults'),
          ),
          testMod.runner(
            dbTestMod.tests,
            document.getElementById('dbTestResults'),
          ),
          testMod.runner(
            fluidTestMod.tests,
            document.getElementById('fluidTestResults'),
          ),
          testMod.runner(
            preludeTestMod.tests,
            document.getElementById('preludeTestResults'),
          ),
        ]);
        return;
      };

      const reload = async (stamp) => {
        clearResults();
        await loadModules(stamp);
        return runTests();
      };

      await reload(false);

      try {
        const eventSource = new EventSource('/events');
        eventSource.addEventListener('reload', reload);
      } catch (err) {
        console.log('No /events endpoint found.');
      }
    </script>
  </body>
</html>

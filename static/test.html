<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>js-bits tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="data:," />
    <style>
      .results {
        font-family: monospace;
      }
      .passed {
        color: green;
      }
      .failed {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Test Results</h1>

    <h2>crypto.mjs</h2>
    <div class="results" id="cryptoTestResults"></div>

    <h2>db.mjs</h2>
    <div class="results" id="dbTestResults"></div>

    <h2>fluid.mjs</h2>
    <div class="results" id="fluidTestResults"></div>

    <script type="module">
      let test;
      let cryptoTest;
      let dbTest;
      let fluidTest;

      const clearResults = () => {
        const cryptoResultsDiv = document.getElementById('cryptoTestResults');
        cryptoResultsDiv.innerHTML = '';
        const dbResultsDiv = document.getElementById('dbTestResults');
        dbResultsDiv.innerHTML = '';
        const fluidResultsDiv = document.getElementById('fluidTestResults');
        fluidResultsDiv.innerHTML = '';
      };

      const loadModules = async (stamp = true) => {
        const timestamp = new Date().getTime();
        const testModulePath = stamp
          ? `./test.mjs?v=${timestamp}`
          : './test.mjs';
        const cryptoTestModulePath = stamp
          ? `./crypto.test.mjs?v=${timestamp}`
          : './crypto.test.mjs';
        const dbTestModulePath = stamp
          ? `./db.test.mjs?v=${timestamp}`
          : './db.test.mjs';
        const fluidTestModulePath = stamp
          ? `./fluid.test.mjs?v=${timestamp}`
          : './fluid.test.mjs';
        test = await import(testModulePath);
        cryptoTest = await import(cryptoTestModulePath);
        dbTest = await import(dbTestModulePath);
        fluidTest = await import(fluidTestModulePath);
      };

      const runTests = async () => {
        await test.runner(
          cryptoTest.tests,
          document.getElementById('cryptoTestResults'),
        );
        await test.runner(
          dbTest.tests,
          document.getElementById('dbTestResults'),
        );
        await test.runner(
          fluidTest.tests,
          document.getElementById('fluidTestResults'),
        );
        return;
      };

      const reload = async (stamp) => {
        clearResults();
        await loadModules(stamp);
        return runTests();
      };

      await reload(false);

      try {
        const eventSource = new EventSource('/events');
        eventSource.addEventListener('reload', reload);
      } catch (err) {
        console.log('No /events endpoint found.');
      }
    </script>
  </body>
</html>
